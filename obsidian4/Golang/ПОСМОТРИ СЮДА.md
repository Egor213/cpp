–û—Ç–ª–∏—á–Ω–æ! –î–∞–≤–∞–π —Ä–µ–∞–ª–∏–∑—É–µ–º —ç—Ç–æ –Ω–∞ Go, –∏—Å–ø–æ–ª—å–∑—É—è `pgx` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å PostgreSQL —á–µ—Ä–µ–∑ `pgpool` –∏ –¥–æ–±–∞–≤–∏–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã **retry** –∏ **circuit breaker**. –Ø –ø–æ–∫–∞–∂—É –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π –ø—Ä–∏–º–µ—Ä —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏.

---

### 1Ô∏è‚É£ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
go get github.com/jackc/pgx/v5
go get github.com/sony/gobreaker
```

- `pgx/v5` ‚Äî –¥—Ä–∞–π–≤–µ—Ä PostgreSQL.
    
- `gobreaker` ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ **circuit breaker**.
    

---

### 2Ô∏è‚É£ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL —á–µ—Ä–µ–∑ pgpool

```go
package main

import (
    "context"
    "fmt"
    "time"

    "github.com/jackc/pgx/v5/pgxpool"
    "github.com/sony/gobreaker"
)

func main() {
    dsn := "postgres://user:password@pgpool-host:5432/dbname"
    config, err := pgxpool.ParseConfig(dsn)
    if err != nil {
        panic(err)
    }

    pool, err := pgxpool.NewWithConfig(context.Background(), config)
    if err != nil {
        panic(err)
    }
    defer pool.Close()

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Circuit Breaker
    cb := gobreaker.NewCircuitBreaker(gobreaker.Settings{
        Name:        "PostgresCB",
        MaxRequests: 3,
        Interval:    5 * time.Second,
        Timeout:     10 * time.Second,
        ReadyToTrip: func(counts gobreaker.Counts) bool {
            return counts.ConsecutiveFailures > 3
        },
    })

    // –ü—Ä–∏–º–µ—Ä –≤—ã–∑–æ–≤–∞ —Å retry –∏ circuit breaker
    result, err := RetryCircuitBreaker(context.Background(), cb, pool, 3)
    if err != nil {
        fmt.Println("–û—à–∏–±–∫–∞:", err)
    } else {
        fmt.Println("–†–µ–∑—É–ª—å—Ç–∞—Ç:", result)
    }
}
```

---

### 3Ô∏è‚É£ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ **retry + circuit breaker**

```go
func RetryCircuitBreaker(ctx context.Context, cb *gobreaker.CircuitBreaker, pool *pgxpool.Pool, maxRetries int) (string, error) {
    var lastErr error
    for i := 0; i < maxRetries; i++ {
        result, err := cb.Execute(func() (interface{}, error) {
            // –ó–¥–µ—Å—å —Ä–µ–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –≤ PostgreSQL —á–µ—Ä–µ–∑ pgpool
            var greeting string
            err := pool.QueryRow(ctx, "SELECT 'Hello, World!'").Scan(&greeting)
            return greeting, err
        })

        if err == nil {
            return result.(string), nil
        }

        lastErr = err
        fmt.Printf("–ü–æ–ø—ã—Ç–∫–∞ %d –Ω–µ —É–¥–∞–ª–∞—Å—å: %v. Retry —á–µ—Ä–µ–∑ 1 —Å–µ–∫...\n", i+1, err)
        time.Sleep(1 * time.Second)
    }
    return "", fmt.Errorf("–≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ —É–¥–∞–ª–∏—Å—å: %w", lastErr)
}
```

---

### üîπ –ü–æ—è—Å–Ω–µ–Ω–∏—è

1. **Circuit Breaker (`gobreaker`)**:
    
    - –ï—Å–ª–∏ –ø–æ–¥—Ä—è–¥ 3 –∑–∞–ø—Ä–æ—Å–∞ —É–ø–∞–¥—É—Ç ‚Äî `circuit breaker` –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –Ω–∞ 10 —Å–µ–∫—É–Ω–¥.
        
    - –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ `MaxRequests` –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ —Å–µ—Ä–≤–∏—Å —Å–Ω–æ–≤–∞.
        
2. **Retry**:
    
    - –ú—ã –ø–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å `maxRetries` —Ä–∞–∑, —Å –ø–∞—É–∑–æ–π –≤ 1 —Å–µ–∫—É–Ω–¥—É.
        
    - –ï—Å–ª–∏ `circuit breaker` –æ—Ç–∫—Ä—ã—Ç ‚Äî `cb.Execute` —Å—Ä–∞–∑—É –≤–µ—Ä–Ω—ë—Ç –æ—à–∏–±–∫—É.
        
3. **Pgpool**:
    
    - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ DSN –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –æ–±—ã—á–Ω–æ–µ PostgreSQL.
        
    - Pgpool –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫—É –∏ failover –Ω–∞ —É—Ä–æ–≤–Ω–µ PostgreSQL.
        

---

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —è –º–æ–≥—É —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑–∞—Ç—å **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º–∏ –∏ —Ç–∞–π–º-–∞—É—Ç–∞–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞**, —á—Ç–æ–±—ã retries –∏ circuit breaker —Ä–∞–±–æ—Ç–∞–ª–∏ –±–æ–ª–µ–µ ‚Äú–ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ‚Äù –¥–ª—è –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤.

–•–æ—á–µ—à—å —Ç–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç?




!!! https://vscode.dev/github/rusblaze/lecture_debug?vscode-lang=ru
–¢—É—Ç –∂–µ—Å—Ç–∫–∏–π –º–∏–¥–ª –≤–∞—Ä–µ
