Хранятся в Heap. Каналы это структура с множеством полей. Она называется `hchan`.
Там содержатся следующие поля:
- qcount - текущее количество элементов в канале
- dataqsize - размерность канала. Capacity, если канал буферизированный
- *buf - указатель на буффер он представляет из себя кольцевую очередь. Пришедшие сюда данные копируются в буфер.
- closed - состояние закрытости канала. Он работает под атомика, из-за чего имеет тип int32
- `recvq` и `sendq` - очереди ожидающих горутин. Когда горутина хочет написать в переполненный канал или прочитать из пустого канала, она кладется в одну из этих очередей
- `recvx` и `sendx` - это счетчики, они указывают в какой элемент или с какого элемента будет производится запись или чтение.
- `lock` - mutex для блокировки

Когда буфер переполняется, горутину необходимо поставить на паузу, для этого вызывается функция gopark(), которая идет напрямую к планировщику, он меняет состояние горутины с `running` на `wainting`, после чего разрывает связь между горутиной и системным потоком. Чтобы поток не простаивал, планировщик находит следующую горутину и ставит ее на выполнение.

Но нам надо будет разбудить эту горутину, когда место в канале освободится, для этого горутина попадает в канал `sendq`. Внутри это связанный список структур `sudog`, он хранит саму горутину и элемент, который надо положить в канал. Если бы горутина хотела получить данные из канала, то `elem` представлял бы из себя место, куда положить данные из канала.

Далее приходит читатель и освобождает буфер + освобождает от работы горутину в `sendq`, он выполняет за него работу и сам достает данные, после чего вызывает `goready()` и отдает ее планировщику, горутина меняет состояние на `running` и кладет в очередь запуска планировщика.

Если приходит горутина, а канал пустой, то он попадет в `recvq` и ожидает данные. Когда приходит писатель, он пишет данные не сразу в канал, а сначала смотрит в `recvq` и, если там есть горутина, пишет данные в стек той ожидающей горутины.

В небуферизированных канал все проще, данные передаются напрямую из стека одной горутины, в стек другой горутины.

![[Pasted image 20250831142316.png]]

